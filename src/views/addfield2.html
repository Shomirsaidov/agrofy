<template>
    <div>
      <TopBar />
  
      <div class="px-40 p-3 rounded-xl">
        <div class="flex p-3 space-x-6">
          <!-- Left Column: Input fields -->
          <div>
            <h3 class="text-2xl font-bold text-my text-start my-6">Add your field</h3>
            <div class="myGreen2 rounded-xl p-3 space-y-3">
              <!-- Bind data properties to input fields -->
              <input
                type="text"
                v-model="fieldTitle"
                placeholder="Add a title"
                class="focus:shadow-md border p-4 outline-none rounded-xl w-full"
              />
              <div class="flex space-x-3">
                <input
                  type="text"
                  v-model="soilType"
                  placeholder="Soil type"
                  class="focus:shadow-md border p-4 outline-none rounded-xl"
                />
                <input
                  type="text"
                  v-model="fieldArea"
                  placeholder="Field area"
                  class="focus:shadow-md border p-4 outline-none rounded-xl"
                />
              </div>
              <textarea
                v-model="description"
                placeholder="Type a description"
                class="focus:shadow-md border w-full p-4 outline-none rounded-xl"
              ></textarea>
  
              <!-- Uploadcare Widget for Multiple Image Uploads -->
              <input
                id="uploadcare-widget" 
                role="uploadcare-uploader"
                type="hidden"
                data-crop="free"
                data-multiple="true"
                data-public-key="a0c09e05ae42395c7d5c"
              />
  
              <!-- Display uploaded image URLs -->
              <div v-if="uploadedImageUrls.length > 0" class="mt-4 p-4 bg-gray-100 rounded-lg">
                <p class="text-sm text-gray-700">Uploaded Image URLs:</p>
                <ul class="list-disc ml-5">
                  <li v-for="url in uploadedImageUrls" :key="url" class="text-blue-500 underline">
                    <a :href="url" target="_blank">{{ url }}</a>
                  </li>
                </ul>
              </div>
  
              <!-- Send data on button click -->
              <button @click="sendData" class="p-4 w-full myGreen4 text-white font-bold rounded-lg my-8">
                Continue
              </button>
            </div>
          </div>
  
          <!-- Right Column: Map container -->
          <div class="w-full">
            <h3 class="text-xl font-bold text-my text-start my-6">Select your area</h3>
            <div id="map" class="w-full h-96 rounded-xl"></div>
          </div>
        </div>
      </div>
    </div>
  </template>
  
  <script>
  import TopBar from '@/components/TopBar.vue';
  import L from 'leaflet'; // Import Leaflet library
  import axios from 'axios';
  
  export default {
    components: {
      TopBar,
    },
    data() {
      return {
        fieldTitle: '',               // Title of the field
        soilType: '',                 // Soil type input value
        fieldArea: '',                // Field area input value
        description: '',              // Field description
        fieldCords: null,             // Coordinates selected on the map
        uploadedImageUrls: [],        // Array to store URLs of uploaded images
        map: null,                    // Store the Leaflet map instance
        marker: null,                 // Store the Leaflet marker instance
      };
    },
    mounted() {
      // Initialize the map once the component is mounted
      this.initMap();
  
      // Manually attach the Uploadcare event listener
      this.initUploadcareWidget();
    },
    methods: {
      initUploadcareWidget() {
        // Wait for the Uploadcare widget to be ready and then set up event listeners
        this.$nextTick(() => {
          const widget = uploadcare.Widget('#uploadcare-widget');
          
          // Listen for the file selection event
          widget.onChange((fileGroup) => {
            if (fileGroup) {
              fileGroup.promise().then((groupInfo) => {
                // Extract URLs of all uploaded files and store them in `uploadedImageUrls`
                this.uploadedImageUrls = groupInfo.files().map(file => file.cdnUrl);
                console.log('Uploaded file URLs:', this.uploadedImageUrls); // Debugging log
              });
            }
          });
        });
      },
      async sendData() {
        try {
          // Construct data object to be sent with the POST request
          const postData = {
            title: this.fieldTitle,
            soil_type: this.soilType,
            field_area: this.fieldArea,
            description: this.description,
            coordinates: this.fieldCords,
            image_urls: this.uploadedImageUrls,
          };
  
          console.log('Sending data:', postData); // Debugging log
  
          // Send POST request
          const response = await axios.post('https://your-api-endpoint.com/fields', postData);
          console.log('Response:', response.data);
          
          // Handle success (e.g., show a notification, redirect, etc.)
          alert('Field added successfully!');
        } catch (error) {
          console.error('Error sending data:', error);
          alert('Failed to add the field. Please try again.');
        }
      },
      initMap() {
        // Create the map and set its initial view
        this.map = L.map('map').setView([51.505, -0.09], 13); // Replace with your desired coordinates
  
        // Add a tile layer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors',
        }).addTo(this.map);
  
        // Listen for map click events
        this.map.on('click', this.onMapClick);
      },
      onMapClick(event) {
        // Extract latitude and longitude from the click event
        const { lat, lng } = event.latlng;
  
        // If a marker already exists, update its position
        if (this.marker) {
          this.marker.setLatLng([lat, lng]);
        } else {
          // Otherwise, create a new marker at the clicked position
          this.marker = L.marker([lat, lng]).addTo(this.map);
        }
  
        // Optionally, show a popup with coordinates on the marker
        this.marker.bindPopup(`Latitude: ${lat.toFixed(5)}, Longitude: ${lng.toFixed(5)}`).openPopup();
  
        // Save the coordinates
        this.fieldCords = { lat, lng };
      },
    },
  };
  </script>
  
  <style scoped>
  /* Add any custom styles for the component here if needed */
  </style>
  